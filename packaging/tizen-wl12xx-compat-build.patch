--- wl12xx-compat-build.sh	2012-05-28 16:13:22.098109661 +0300
+++ wl12xx-compat-build-tz.sh	2012-05-29 15:29:33.146379726 +0300
@@ -42,15 +42,15 @@
 init_variables() {
     local custom_board=$1
 
-    if [ -z "${TARGET_TOOLS_PREFIX}" ]; then
-        echo >&3 "Warning: TARGET_TOOLS_PREFIX was not set."
-	TARGET_TOOLS_PREFIX=$TOP/prebuilt/linux-x86/toolchain/i686-android-linux-4.4.3/bin/i686-android-linux-
-    fi
+#    if [ -z "${TARGET_TOOLS_PREFIX}" ]; then
+#        echo >&3 "Warning: TARGET_TOOLS_PREFIX was not set."
+#	TARGET_TOOLS_PREFIX=$TOP/prebuilt/linux-x86/toolchain/i686-android-linux-4.4.3/bin/i686-android-linux-
+#    fi
     if [ -z "${CCACHE_TOOLS_PREFIX}" ]; then
         echo >&3 "Warning: CCACHE_TOOLS_PREFIX was not set."
 	CCACHE_TOOLS_DIR=$TOP/prebuilt/linux-x86/ccache
     fi
-    export PATH="`dirname ${TARGET_TOOLS_PREFIX}`:$PATH"
+#    export PATH="`dirname ${TARGET_TOOLS_PREFIX}`:$PATH"
     if [ -z "$CROSS_COMPILE" ];then
         export CROSS_COMPILE="`basename ${TARGET_TOOLS_PREFIX}`"
     fi
@@ -59,7 +59,7 @@
         export CROSS_COMPILE="ccache $CROSS_COMPILE"
     fi
     export ARCH=i386
-    export CFLAGS=-mno-android
+#    export CFLAGS=-mno-android
     echo >&3 "ARCH: $ARCH"
     echo >&3 "CROSS_COMPILE: $CROSS_COMPILE"
     echo >&3 "PATH: $PATH"
@@ -85,30 +85,34 @@
     esac
 
     PRODUCT_OUT=${TOP}/out/target/product/${BOARD}
-    KERNEL_BUILD_DIR=${PRODUCT_OUT}/kernel_build
+#    KERNEL_BUILD_DIR=${PRODUCT_OUT}/kernel_build
+    KERNEL_BUILD_DIR=${TOP}
 }
 
 make_compat() {
     echo "  Making wl12xx compat wireless"
-    local COMPAT_SRC_DIR=$TOP/hardware/ti/wlan/wl12xx-compat/
-    local MODULE_DEST_TMP=${PRODUCT_OUT}/compat_modules
+#    local COMPAT_SRC_DIR=$TOP/hardware/ti/wlan/wl12xx-compat/
+    local COMPAT_SRC_DIR=$TOP/ti-wlan/wl12xx-compat/
+#    local MODULE_DEST_TMP=${PRODUCT_OUT}/compat_modules
+    local MODULE_DEST_TMP=${INSTALL_MOD_PATH}
     local MODULE_DEST=${PRODUCT_OUT}/root/lib/modules
 
     cd ${COMPAT_SRC_DIR}
 
-    make ARCH=${ARCH} KLIB=${MODULE_DEST_TMP} KLIB_BUILD=${KERNEL_BUILD_DIR} clean
-    exit_on_error $? quiet
+#    make ARCH=${ARCH} KLIB=${MODULE_DEST_TMP} KLIB_BUILD=${KERNEL_BUILD_DIR} clean
+#    exit_on_error $? quiet
 
     make ARCH=${ARCH} KLIB=${MODULE_DEST_TMP} KLIB_BUILD=${KERNEL_BUILD_DIR} 
     exit_on_error $? quiet
 
-    rm -rf ${MODULE_DEST_TMP}
+#    rm -rf ${MODULE_DEST_TMP}
     mkdir -p ${MODULE_DEST_TMP};
-    make ARCH=${ARCH} INSTALL_MOD_STRIP=--strip-unneeded KLIB=${MODULE_DEST_TMP} KLIB_BUILD=${KERNEL_BUILD_DIR} install-modules
+#    make ARCH=${ARCH} INSTALL_MOD_STRIP=--strip-unneeded KLIB=${MODULE_DEST_TMP} KLIB_BUILD=${KERNEL_BUILD_DIR} install-modules
+    make ARCH=${ARCH} KLIB=${MODULE_DEST_TMP} KLIB_BUILD=${KERNEL_BUILD_DIR} install-modules
     exit_on_error $? quiet
 
-    find ${MODULE_DEST_TMP} -name *.ko -exec cp -vf {} ${MODULE_DEST} \;
-    exit_on_error $? quiet
+#    find ${MODULE_DEST_TMP} -name *.ko -exec cp -vf {} ${MODULE_DEST} \;
+#    exit_on_error $? quiet
 
     cd ${TOP}
 }
